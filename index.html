<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Đề Trắc Nghiệm Tiếng Anh (JSON)</title>
  <style>
    /* Bạn có thể giữ nguyên file CSS cũ, ở đây mình thêm tí style tối thiểu để xem nhanh */
    body { font-family: "Times New Roman", Times, serif; margin: 0; color:#333; }
    .header-banner { background:#1a5276; height:8px; }
    .main-container { max-width: 900px; margin: 24px auto; padding: 0 16px; }
    .title-box { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
    .teacher-img-placeholder { width:40px; height:40px; background:#eee; border-radius:50%; }
    .main-title { font-size:24px; margin:0; font-weight:700; }
    .question { padding:10px 0; border-bottom:1px dashed #ddd; }
    .question-number { font-weight:700; margin-right:8px; }
    .options { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:6px 24px; margin-top:8px; }
    .option { margin:0; }
    .option-letter { font-weight:700; margin-right:6px; }
    .page-break-before { page-break-before: always; margin-top:24px; }
    .answer-key { max-width: 900px; margin: 0 auto; padding: 0 16px 40px; }
    .answer-title-box{ margin-bottom:8px; }
    .answer-title{ font-weight:700; font-size:20px; }
    .answer-list{ display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:6px 16px; list-style: none; padding:0; margin:0; }
    .answer-item{ padding:6px 8px; border:1px solid #eee; border-radius:6px; }
    .q{ margin-right:6px; font-weight:600; }
    .toolbar{ max-width:900px; margin:0 auto; padding:0 16px 8px; display:flex; gap:8px; align-items:center; }
    textarea.json-input{ width:100%; height:120px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .hint{ font-size:12px; color:#666; }
    button{ padding:6px 10px; border:1px solid #ddd; background:#fafafa; border-radius:6px; cursor:pointer; }
    button:hover{ background:#f0f0f0; }
  </style>
</head>
<body>
  <div class="header-banner"></div>

  <div class="toolbar">
    <button id="btn-load-src">Nạp từ ?src=</button>
    <button id="btn-load-data">Nạp từ ?data=</button>
    <button id="btn-use-embedded">Dùng JSON n8n nhúng</button>
  </div>

  <div class="main-container">
    <div class="title-box">
      <div class="teacher-profile" style="display:flex; align-items:center; gap:8px;">
        <div class="teacher-img-placeholder"></div>
        Cô Phương Thảo
      </div>
      <p class="encouragement" style="margin:0 0 0 auto;" ></p>
      <h1 class="main-title">Choose the best answer</h1>
    </div>

    <!-- Ô dán JSON thủ công (fallback) -->
    <div style="max-width:900px; margin-bottom:12px;">
      <textarea id="json-input" class="json-input" placeholder='Dán JSON câu hỏi vào đây rồi bấm "Nạp JSON"'></textarea>
      <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
        <button id="btn-apply-json">Nạp JSON</button>
        <span class="hint">Hỗ trợ các biến thể: <code>question</code> hoặc <code>text</code>, <code>answer</code> là A/B/C/D hoặc <code>answerIndex</code> (0-3) hoặc <code>answerText</code> (trùng option).</span>
      </div>
    </div>

    <!-- NƠI RENDER CÂU HỎI -->
    <div id="questions-container" class="questions-container"></div>
  </div>

  <!-- Trang đáp án tự động -->
  <div class="page-break-before"></div>
  <section class="answer-key">
    <div class="answer-title-box">
      <div class="answer-title">ĐÁP ÁN</div>
    </div>
    <div id="answer-key"></div>
  </section>

  <!-- Footer (giữ khung) -->
  <div class="footer">
    <div class="footer-content"><div class="copyright"></div></div>
    <div class="page-number"></div>
  </div>

  <!-- ========= N8N INJECTION (đừng sửa dòng này) ========= -->
  <script>
    // n8n sẽ thay thế biểu thức bên trong {{...}} bằng dữ liệu thực
    // Ưu tiên: nếu body có { "questions": [...] } thì lấy mảng đó;
    // nếu body là mảng thuần [] thì cũng dùng luôn; nếu không có, để null.
    window.__QUESTIONS__ = {{ 
      $json.questions 
        ? JSON.stringify($json.questions) 
        : (Array.isArray($json) ? JSON.stringify($json) : 'null') 
    }};
  </script>

  <!-- ========= RENDER SCRIPT ========= -->
  <script>
  // Utils
  function letterFromIndex(i){ return String.fromCharCode(65 + i); } // 0->A,1->B...
  function idxFromLetter(ch){ return (ch||'').toUpperCase().charCodeAt(0) - 65; }

  // Chuẩn hoá 1 item câu hỏi về format thống nhất
  function normalizeItem(raw, idx){
    const id = raw.id ?? (idx+1);
    const text = raw.question || raw.text || '';
    const options = raw.options || [];
    // Xác định đáp án
    let answer = raw.answer;        // "A" | "B" | ...
    let answerIndex = raw.answerIndex; // 0..3
    const answerText = raw.answerText;

    // Nếu có answerText thì map sang index
    if (answerText && options.length){
      const pos = options.findIndex(o => String(o).trim() === String(answerText).trim());
      if (pos >= 0) answerIndex = pos;
    }

    // Nếu có answer là chữ cái thì chuyển sang index
    if (typeof answer === 'string' && /^[A-Da-d]$/.test(answer)){
      answerIndex = idxFromLetter(answer);
    }

    // Nếu cả hai chưa có mà options có cờ đúng (trường hợp đặc biệt)
    if (answerIndex == null && Array.isArray(options)){
      const pos = options.findIndex(o => typeof o === 'object' && o && o.correct === true);
      if (pos >= 0) answerIndex = pos;
    }

    // Fallback an toàn
    if (typeof answerIndex !== 'number' || isNaN(answerIndex)){
      answerIndex = 0; // mặc định A
    }

    // Chuyển options object -> string nếu lỡ truyền dạng {text:"...", correct:true}
    const flatOptions = options.map(o => {
      if (typeof o === 'object' && o && 'text' in o) return String(o.text);
      return String(o);
    });

    return {
      id,
      text,
      options: flatOptions,
      answerIndex,
      answer: letterFromIndex(answerIndex)
    };
  }

  function render(questions){
    // Chuẩn hoá toàn bộ
    const data = (questions || []).map(normalizeItem);

    // Render câu hỏi
    const container = document.getElementById("questions-container");
    container.innerHTML = "";
    data.forEach((q) => {
      const wrap = document.createElement("div");
      wrap.classList.add("question");

      const qHtml = `
        <p>
          <span class="question-number">${q.id}.</span>
          <span class="question-text">${q.text}</span>
        </p>
      `;

      const optsHtml = q.options.map((opt, i) => {
        const letter = letterFromIndex(i);
        return `<p class="option"><span class="option-letter">${letter}.</span> ${opt}</p>`;
      }).join("");

      wrap.innerHTML = qHtml + `<div class="options">${optsHtml}</div>`;
      container.appendChild(wrap);
    });

    // Render đáp án
    const answerWrap = document.getElementById("answer-key");
    const items = data.map(q =>
      `<li class="answer-item"><span class="q">Câu ${q.id}:</span><span class="ans">${q.answer}</span></li>`
    ).join("");
    answerWrap.innerHTML = `<ol class="answer-list">${items}</ol>`;
  }

  // ===== Nguồn dữ liệu =====
  async function getFromSrcParam(){
    const url = new URL(location.href);
    const src = url.searchParams.get('src');
    if(!src) return null;
    const res = await fetch(src, {cache:'no-store'});
    if(!res.ok) throw new Error('Không tải được src JSON');
    return await res.json();
  }

  function getFromDataParam(){
    const url = new URL(location.href);
    const data = url.searchParams.get('data');
    if(!data) return null;
    try {
      return JSON.parse(decodeURIComponent(data));
    } catch(e){
      console.warn('data param không phải JSON hợp lệ');
      return null;
    }
  }

  // ===== Khởi tạo =====
  async function boot(){
    // Ưu tiên 1: JSON n8n nhúng
    if (Array.isArray(window.__QUESTIONS__) && window.__QUESTIONS__.length){
      render(window.__QUESTIONS__);
      return;
    }
    // Ưu tiên 2: ?data=
    const fromData = getFromDataParam();
    if (fromData){
      const arr = Array.isArray(fromData) ? fromData : (fromData.questions || []);
      if (arr.length){ render(arr); return; }
    }
    // Ưu tiên 3: ?src=
    try{
      const fromSrc = await getFromSrcParam();
      if (fromSrc){
        const arr = Array.isArray(fromSrc) ? fromSrc : (fromSrc.questions || []);
        if (arr.length){ render(arr); return; }
      }
    }catch(e){ console.warn(e); }

    // Chưa có dữ liệu -> chờ người dùng dán vào ô textarea
    render([]);
  }

  // Nút tiện ích
  document.getElementById('btn-load-src').addEventListener('click', async ()=>{
    try{
      const fromSrc = await getFromSrcParam();
      const arr = Array.isArray(fromSrc) ? fromSrc : (fromSrc?.questions || []);
      render(arr || []);
    }catch(e){ alert('Không tải được ?src='); }
  });
  document.getElementById('btn-load-data').addEventListener('click', ()=>{
    const fromData = getFromDataParam();
    const arr = Array.isArray(fromData) ? fromData : (fromData?.questions || []);
    render(arr || []);
  });
  document.getElementById('btn-use-embedded').addEventListener('click', ()=>{
    const arr = Array.isArray(window.__QUESTIONS__) ? window.__QUESTIONS__ : (window.__QUESTIONS__?.questions || []);
    render(arr || []);
  });
  document.getElementById('btn-apply-json').addEventListener('click', ()=>{
    try{
      const raw = document.getElementById('json-input').value.trim();
      const parsed = JSON.parse(raw);
      const arr = Array.isArray(parsed) ? parsed : (parsed.questions || []);
      render(arr || []);
    }catch(e){
      alert('JSON không hợp lệ');
    }
  });

  // Chạy
  boot();
  </script>
</body>
</html>
